<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgendaSync - Agendamento</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Inter', sans-serif; background:#f5f5f5; margin:0; padding:0; }
.container { max-width:1000px; margin:30px auto; padding:20px; background:#fff; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
h1 { text-align:center; color:#ff6a00; margin-bottom:20px; }
.calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap:5px; margin-top:20px; }
.day { padding:10px; background:#eee; border-radius:8px; cursor:pointer; text-align:center; }
.day.indisponivel { background:#ccc; cursor:not-allowed; color:#999; }
.day.confirmado { background:#4caf50; color:#fff; }
.day.pendente { background:#ffeb3b; }
.day.cancelado { background:#f44336; color:#fff; }
.legend { display:flex; gap:10px; margin-top:15px; }
.legend div { padding:5px 10px; border-radius:5px; color:#fff; font-weight:600; }
.legend .confirmado { background:#4caf50; }
.legend .pendente { background:#ffeb3b; color:#000; }
.legend .cancelado { background:#f44336; }
</style>
</head>
<body>

<div class="container">
<h1>AgendaSync - Agendamento</h1>

<div id="calendar" class="calendar"></div>
<div class="legend">
  <div class="confirmado">Confirmado</div>
  <div class="pendente">Pendente</div>
  <div class="cancelado">Cancelado</div>
</div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { collection, getDocs, query, where, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const calendarEl = document.getElementById('calendar');
let usuarioAtual;
const proprietarioEmail = "proprietario@agenda.com"; // ajuste para o e-mail do dono do salão

onAuthStateChanged(auth, async (user) => {
  if(!user){ alert('Faça login!'); window.location.href='index.html'; return; }
  usuarioAtual = user;
  await renderCalendar();
});

async function renderCalendar(){
  calendarEl.innerHTML='';
  const hoje = new Date();
  const dias = 30;
  for(let i=0;i<dias;i++){
    const dia = new Date();
    dia.setDate(hoje.getDate()+i);
    const diaStr = dia.toISOString().split('T')[0];
    const div = document.createElement('div');
    div.classList.add('day');
    div.dataset.dia = diaStr;
    div.textContent = diaStr.split('-').reverse().join('/');

    const q = query(collection(db,'agendamentos'), where('data','==',diaStr));
    const snapshot = await getDocs(q);
    let status='';
    snapshot.forEach(docu => {
      const data = docu.data();
      if(usuarioAtual.email === proprietarioEmail || data.userId === usuarioAtual.uid){
        if(data.status==='confirmado') status='confirmado';
        else if(data.status==='pendente') status='pendente';
        else if(data.status==='cancelado') status='cancelado';
      }
    });
    if(status) div.classList.add(status);
    div.addEventListener('click',()=> agendarOuGerir(diaStr));
    calendarEl.appendChild(div);
  }
}

async function agendarOuGerir(dia){
  if(usuarioAtual.email === proprietarioEmail){
    const servico = prompt('Digite o nome do serviço para este dia:');
    if(!servico) return;
    await addDoc(collection(db,'agendamentos'),{
      nomeCliente:'Cliente Exemplo',
      servico,
      data:dia,
      status:'pendente',
      userId:'cliente_id_exemplo'
    });
    alert('Agendamento cadastrado pelo proprietário!');
    await renderCalendar();
  } else {
    const servico = prompt('Digite o serviço que deseja agendar:');
    if(!servico) return;
    await addDoc(collection(db,'agendamentos'),{
      nomeCliente:usuarioAtual.email,
      servico,
      data:dia,
      status:'pendente',
      userId:usuarioAtual.uid
    });
    alert('Agendamento realizado!');
    await renderCalendar();
  }
}
</script>

</body>
</html>
