<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgendaSync - Agendamento</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:#f4f4f4;padding:20px;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
h1,h2,h3{text-align:center;color:#ff6a00;margin:15px 0;}
.container{background:#fff;padding:20px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.2);width:100%;max-width:600px;margin:10px;}
.form-group{margin-bottom:15px;display:flex;flex-direction:column;}
.form-group label{margin-bottom:5px;font-weight:600;}
.form-group input, .form-group select{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:16px;}
.btn{padding:10px 20px;background:#ff6a00;color:#fff;border:none;border-radius:10px;margin:5px;cursor:pointer;}
.btn:hover{background:#ff8c33;}
#servicosList div, #diasIndisponiveisList div{margin:5px 0;padding:5px;border:1px solid #ddd;border-radius:10px;display:flex;justify-content:space-between;align-items:center;}
.calendar{margin-top:20px;display:grid;grid-template-columns:repeat(7,1fr);gap:5px;}
.day{padding:10px;border-radius:10px;text-align:center;cursor:pointer;}
.blocked{background:#ddd;color:#888;cursor:not-allowed;}
.available{background:#a6f0a6;}
.selected{background:#ffbc00;color:#fff;}
</style>
</head>
<body>

<h1>AgendaSync</h1>

<div class="container" id="configProprietario" style="display:none;">
  <h2>Configuração do Salão</h2>
  <div class="form-group">
    <label>Horário Início</label>
    <input type="time" id="horaInicio">
  </div>
  <div class="form-group">
    <label>Horário Fim</label>
    <input type="time" id="horaFim">
  </div>

  <h3>Serviços</h3>
  <div class="form-group">
    <label>Nome do Serviço</label>
    <input type="text" id="servicoNome" placeholder="Ex: Corte">
  </div>
  <div class="form-group">
    <label>Duração (minutos)</label>
    <input type="number" id="servicoDuracao" value="30">
  </div>
  <div class="form-group">
    <label>Valor (R$)</label>
    <input type="number" id="servicoValor" value="50">
  </div>
  <button class="btn" id="adicionarServico">Adicionar Serviço</button>

  <h3>Serviços Cadastrados</h3>
  <div id="servicosList"></div>

  <h3>Dias Indisponíveis</h3>
  <input type="date" id="diaIndisponivel">
  <button class="btn" id="adicionarDiaIndisponivel">Adicionar Dia Indisponível</button>
  <div id="diasIndisponiveisList"></div>

  <button class="btn" id="salvarConfig">Salvar Configuração</button>
</div>

<div class="container calendar" id="calendarContainer" style="display:none;">
  <h2>Calendário de Agendamentos</h2>
  <div id="calendar"></div>
</div>

<audio id="somNotificacao" src="notificacao.mp3" preload="auto"></audio>

<script type="module" src="firebase.js"></script>
<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { doc, getDoc, setDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let usuarioAtual;
let isProprietario = false;
let configSalao = { servicos: [], diasIndisponiveis: [] };
let agendamentos = [];

function tocarSom(){document.getElementById('somNotificacao').play();}

// Função para criar calendário do mês atual
function gerarCalendario(){
  const calendarDiv=document.getElementById('calendar');
  calendarDiv.innerHTML='';
  const hoje = new Date();
  const ano = hoje.getFullYear();
  const mes = hoje.getMonth();
  const diasNoMes = new Date(ano, mes+1, 0).getDate();

  for(let d=1; d<=diasNoMes; d++){
    const dataStr=`${ano}-${String(mes+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const div=document.createElement('div');
    div.classList.add('day');
    div.textContent=d;

    // Verifica dias indisponíveis ou já agendados
    let bloqueado=false;
    if(configSalao.diasIndisponiveis.includes(dataStr)) bloqueado=true;
    if(agendamentos.some(a=>a.data===dataStr)) bloqueado=true;

    if(bloqueado) div.classList.add('blocked'); else div.classList.add('available');

    if(!bloqueado){
      div.addEventListener('click', ()=>{
        const servicoEscolhido=prompt("Digite o nome do serviço que deseja agendar:");
        if(!configSalao.servicos.some(s=>s.nome===servicoEscolhido)){
          alert("Serviço inválido!");
          return;
        }
        agendarHorario(dataStr, servicoEscolhido);
      });
    }

    calendarDiv.appendChild(div);
  }
}

// Função de agendamento
async function agendarHorario(data, servico){
  const docRef=await addDoc(collection(db,'agendamentos'),{
    cliente: usuarioAtual.uid,
    data: data,
    servico: servico
  });
  alert("Agendamento realizado!");
  tocarSom();
  agendamentos.push({cliente: usuarioAtual.uid, data: data, servico: servico});
  gerarCalendario();
}

// Carrega agendamentos do Firestore
async function carregarAgendamentos(){
  const snap=await getDocs(collection(db,'agendamentos'));
  agendamentos=[];
  snap.forEach(doc=>agendamentos.push(doc.data()));
  gerarCalendario();
}

// Carregar configuração e inicializar
onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="index.html"; return; }
  usuarioAtual=user;

  const userSnap=await getDoc(doc(db,'usuarios',user.uid));
  if(!userSnap.exists()){ alert("Usuário não encontrado"); return; }
  isProprietario=userSnap.data().role==="proprietario";

  if(isProprietario) document.getElementById('configProprietario').style.display="block";
  document.getElementById('calendarContainer').style.display="block";

  const configRef=doc(db,'configuracao','salon');
  const configSnap=await getDoc(configRef);
  if(configSnap.exists()){
    configSalao=configSnap.data();
    if(isProprietario){
      document.getElementById('horaInicio').value=configSalao.horaInicio || "08:00";
      document.getElementById('horaFim').value=configSalao.horaFim || "18:00";
      if(configSalao.servicos) configSalao.servicos.forEach(s=>adicionarServicoNaLista(s));
      if(configSalao.diasIndisponiveis) configSalao.diasIndisponiveis.forEach(d=>adicionarDiaIndisponivelNaLista(d));
    }
  } else if(isProprietario){
    configSalao={proprietario:usuarioAtual.uid,horaInicio:"08:00",horaFim:"18:00",servicos:[],diasIndisponiveis:[]};
    await setDoc(configRef,configSalao);
  }

  await carregarAgendamentos();
});

// Proprietário adiciona serviços
document.getElementById('adicionarServico').addEventListener('click', ()=>{
  const nome=document.getElementById('servicoNome').value;
  const duracao=parseInt(document.getElementById('servicoDuracao').value);
  const valor=parseFloat(document.getElementById('servicoValor').value);
  if(!nome||!duracao||!valor){ alert("Preencha todos os campos do serviço!"); return; }
  const servico={nome,duracao,valor};
  configSalao.servicos.push(servico);
  adicionarServicoNaLista(servico);
  document.getElementById('servicoNome').value=""; document.getElementById('servicoDuracao').value=30; document.getElementById('servicoValor').value=50;
});

function adicionarServicoNaLista(servico){
  const div=document.createElement('div');
  div.textContent=`${servico.nome} - ${servico.duracao} min - R$ ${servico.valor.toFixed(2)}`;
  document.getElementById('servicosList').appendChild(div);
}

// Dias indisponíveis
document.getElementById('adicionarDiaIndisponivel').addEventListener('click', ()=>{
  const dia=document.getElementById('diaIndisponivel').value;
  if(!dia){ alert("Selecione um dia!"); return; }
  configSalao.diasIndisponiveis.push(dia);
  adicionarDiaIndisponivelNaLista(dia);
});

function adicionarDiaIndisponivelNaLista(dia){
  const div=document.createElement('div'); div.textContent=dia;
  document.getElementById('diasIndisponiveisList').appendChild(div);
}

// Salvar configuração
document.getElementById('salvarConfig').addEventListener('click', async ()=>{
  if(isProprietario){
    configSalao.horaInicio=document.getElementById('horaInicio').value;
    configSalao.horaFim=document.getElementById('horaFim').value;
    await setDoc(doc(db,'configuracao','salon'),configSalao);
    alert("Configuração salva!");
    tocarSom();
  }
});
</script>
</body>
</html>
