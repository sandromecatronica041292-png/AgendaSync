<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgendaSync - Agendamento</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * {box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
  body{min-height:100vh;display:flex;flex-direction:column;align-items:center;background:#f4f4f4;}
  h1{margin:20px;color:#ff6a00;}
  #calendar{width:90%;max-width:900px;margin-top:20px;}
  .btn{padding:10px 20px;background:#ff6a00;color:#fff;border:none;border-radius:10px;margin:5px;cursor:pointer;}
  .btn:hover{background:#ff8c33;}
</style>
</head>
<body>
<h1>AgendaSync</h1>
<div id="calendar"></div>
<button class="btn" id="config-btn" style="display:none;">Configuração do Salão</button>

<script type="module" src="firebase.js"></script>
<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { doc, getDoc, setDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let usuarioAtual;
let proprietarioConfig;
let isProprietario = false;

onAuthStateChanged(auth, async (user)=>{
  if(user){
    usuarioAtual = user;

    // Verifica se há role
    const userSnap = await getDoc(doc(db,'usuarios',user.uid));
    if(userSnap.exists()){
      const role = userSnap.data().role;
      isProprietario = role==='proprietario';
    }

    // Busca configuração do salão
    const configRef = doc(db,'configuracao','salon');
    const configSnap = await getDoc(configRef);

    if(!configSnap.exists() && isProprietario){
      // Cria configuração mínima automática
      await setDoc(configRef,{
        proprietario: usuarioAtual.uid,
        horaInicio: "08:00",
        horaFim: "18:00",
        servicos: [{nome:"Corte",duracao:30,valor:50}]
      });
      alert("Configuração mínima criada. Edite horários e serviços conforme desejar.");
    }

    // Recarrega configuração
    const novaConfigSnap = await getDoc(configRef);
    if(novaConfigSnap.exists()){
      proprietarioConfig = novaConfigSnap.data();
    } else if(!isProprietario){
      alert("Configuração do salão não encontrada! Contate o proprietário.");
      return;
    }

    // Mostrar botão de configuração somente para proprietário
    if(isProprietario){
      document.getElementById('config-btn').style.display = 'block';
      document.getElementById('config-btn').addEventListener('click',()=>{
        window.location.href = "configuracao.html";
      });
    }

    // Carregar agendamentos
    carregarAgendamentos();
  } else {
    window.location.href = "index.html";
  }
});

// Função para carregar agendamentos
async function carregarAgendamentos(){
  const agendamentosRef = collection(db,'agendamentos');
  let q;

  if(isProprietario){
    q = agendamentosRef; // pega todos
  } else {
    q = query(agendamentosRef, where("userId","==",usuarioAtual.uid)); // pega apenas do usuário
  }

  const querySnapshot = await getDocs(q);
  const calendarDiv = document.getElementById('calendar');
  calendarDiv.innerHTML = "";

  querySnapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const div = document.createElement('div');
    div.style.border="1px solid #ddd";
    div.style.margin="5px";
    div.style.padding="5px";
    div.style.borderRadius="10px";
    div.innerHTML = `<strong>${data.servico}</strong> - ${data.data} ${data.hora} - ${data.clienteEmail || "Cliente"}`
    calendarDiv.appendChild(div);
  });
}
</script>
</body>
</html>
