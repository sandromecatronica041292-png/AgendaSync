<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgendaSync - Configuração do Salão</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing:border-box; margin:0; padding:0; font-family:'Inter',sans-serif; }
  body { min-height:100vh; display:flex; flex-direction:column; align-items:center; background:#f4f4f4; padding:20px; }
  h1,h2 { color:#ff6a00; margin:20px 0; text-align:center; }
  .form-card { background:#fff; padding:20px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.2); margin:10px; width:100%; max-width:500px; }
  .form-group { margin-bottom:15px; display:flex; flex-direction:column; }
  .form-group label { margin-bottom:5px; font-weight:600; }
  .form-group input { padding:10px; border-radius:8px; border:1px solid #ddd; font-size:16px; }
  .btn { padding:10px 20px; background:#ff6a00; color:#fff; border:none; border-radius:10px; margin:5px; cursor:pointer; }
  .btn:hover { background:#ff8c33; }
  #servicosList div { margin:5px 0; padding:5px; border:1px solid #ddd; border-radius:10px; }
</style>
</head>
<body>

<h1>AgendaSync</h1>
<div class="form-card">
  <h2>Configuração do Salão</h2>
  <div class="form-group">
    <label>Horário de Início</label>
    <input type="time" id="horaInicio">
  </div>
  <div class="form-group">
    <label>Horário de Fim</label>
    <input type="time" id="horaFim">
  </div>

  <h2>Serviços</h2>
  <div class="form-group">
    <label>Nome do Serviço</label>
    <input type="text" id="servicoNome" placeholder="Ex: Corte">
  </div>
  <div class="form-group">
    <label>Duração (minutos)</label>
    <input type="number" id="servicoDuracao" value="30">
  </div>
  <div class="form-group">
    <label>Valor (R$)</label>
    <input type="number" id="servicoValor" value="50">
  </div>
  <button class="btn" id="adicionarServico">Adicionar Serviço</button>

  <h3>Serviços Cadastrados</h3>
  <div id="servicosList"></div>

  <button class="btn" id="salvarConfig">Salvar Configuração</button>
</div>

<script type="module" src="firebase.js"></script>
<script type="module">
import { auth, db } from './firebase.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let usuarioAtual;
let proprietarioConfig = { servicos: [] };

onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href = "index.html"; return; }
  usuarioAtual = user;

  // Verifica role
  const userSnap = await getDoc(doc(db,'usuarios',user.uid));
  if(!userSnap.exists() || userSnap.data().role !== 'proprietario'){
    alert("Acesso negado! Apenas proprietário pode acessar.");
    window.location.href = "index.html";
    return;
  }

  // Carrega configuração existente
  const configRef = doc(db,'configuracao','salon');
  const configSnap = await getDoc(configRef);

  if(configSnap.exists()){
    proprietarioConfig = configSnap.data();
    document.getElementById('horaInicio').value = proprietarioConfig.horaInicio || "08:00";
    document.getElementById('horaFim').value = proprietarioConfig.horaFim || "18:00";
    if(proprietarioConfig.servicos){
      proprietarioConfig.servicos.forEach(s => adicionarServicoNaLista(s));
    }
  } else {
    // Cria configuração mínima
    proprietarioConfig = {
      proprietario: usuarioAtual.uid,
      horaInicio: "08:00",
      horaFim: "18:00",
      servicos: []
    };
    await setDoc(configRef, proprietarioConfig);
  }
});

// Adicionar serviço na lista da tela
document.getElementById('adicionarServico').addEventListener('click', ()=>{
  const nome = document.getElementById('servicoNome').value;
  const duracao = parseInt(document.getElementById('servicoDuracao').value);
  const valor = parseFloat(document.getElementById('servicoValor').value);

  if(!nome || !duracao || !valor){ alert("Preencha todos os campos do serviço!"); return; }

  const servico = { nome, duracao, valor };
  proprietarioConfig.servicos.push(servico);
  adicionarServicoNaLista(servico);

  // Limpar campos
  document.getElementById('servicoNome').value = "";
  document.getElementById('servicoDuracao').value = 30;
  document.getElementById('servicoValor').value = 50;
});

function adicionarServicoNaLista(servico){
  const div = document.createElement('div');
  div.textContent = `${servico.nome} - ${servico.duracao} min - R$ ${servico.valor.toFixed(2)}`;
  document.getElementById('servicosList').appendChild(div);
}

// Salvar configuração no Firestore
document.getElementById('salvarConfig').addEventListener('click', async ()=>{
  const horaInicio = document.getElementById('horaInicio').value;
  const horaFim = document.getElementById('horaFim').value;

  if(!horaInicio || !horaFim){
    alert("Defina o horário de início e fim do expediente.");
    return;
  }

  proprietarioConfig.horaInicio = horaInicio;
  proprietarioConfig.horaFim = horaFim;

  await setDoc(doc(db,'configuracao','salon'), proprietarioConfig);
  alert("Configuração salva com sucesso!");
});
</script>
</body>
</html>
